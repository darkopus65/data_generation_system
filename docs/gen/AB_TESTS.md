# A/B тесты

Генератор включает 6 предзаданных A/B тестов с реалистичными эффектами на поведение игроков.

## Содержание

- [Механика распределения](#механика-распределения)
- [Предзаданные тесты](#предзаданные-тесты)
  - [onboarding_length](#1-onboarding_length)
  - [starter_pack_price](#2-starter_pack_price)
  - [gacha_pity_display](#3-gacha_pity_display)
  - [energy_regen_rate](#4-energy_regen_rate)
  - [ad_reward_amount](#5-ad_reward_amount)
  - [late_game_offer](#6-late_game_offer)
- [Формат в событиях](#формат-в-событиях)
- [Добавление своих тестов](#добавление-своих-тестов)
- [Учебные задания](#учебные-задания)

---

## Механика распределения

Каждый игрок распределяется в группы A/B тестов **при установке** детерминированно на основе:
- `seed` симуляции
- Названия теста
- `user_id` игрока

```python
hash_input = f"{seed}:{test_name}:{user_id}"
hash_value = md5(hash_input)
# Выбор варианта по весам
```

**Важно:**
- Распределение сохраняется на всё время жизни игрока
- Один игрок может участвовать в нескольких тестах одновременно
- Эффекты тестов кумулятивны (могут взаимодействовать)

---

## Предзаданные тесты

### 1. onboarding_length

**Гипотеза:** Короткий туториал улучшает D1 retention, но ухудшает D7 из-за непонимания механик.

| Вариант | Описание | Эффект |
|---------|----------|--------|
| `control` | Стандартный туториал (8 шагов) | Базовые значения |
| `short` | Короткий туториал (4 шага) | D1 +5%, D7 -8% |
| `extended` | Расширенный туториал (12 шагов) | D1 -3%, D7 +4% |

**Распределение:** 33% / 33% / 34%

**Что меняется:**
- Количество шагов туториала
- Вероятность возврата на D1 и D7

---

### 2. starter_pack_price

**Гипотеза:** Более низкая цена увеличивает конверсию, но снижает ARPPU.

| Вариант | Цена | Эффект |
|---------|------|--------|
| `control` | $0.99 | Базовая конверсия |
| `higher` | $1.99 | Конверсия -40% |
| `lower` | $0.49 | Конверсия +60% |

**Распределение:** 33% / 33% / 34%

**Что меняется:**
- Цена стартового пакета
- Вероятность покупки стартового пакета

**Trade-off:**
- `lower`: больше покупателей, но меньше выручка с каждого
- `higher`: меньше покупателей, но выше ARPPU

---

### 3. gacha_pity_display

**Гипотеза:** Отображение pity-счётчика увеличивает количество призывов.

| Вариант | Описание | Эффект |
|---------|----------|--------|
| `control` | Pity скрыт | Базовое поведение |
| `visible` | Pity показан | +15% призывов при pity > 50 |

**Распределение:** 50% / 50%

**Что меняется:**
- Желание делать призывы (`gacha_desire`) увеличивается на 15% когда pity > 50

**Механика:** Когда игрок видит, что до гарантии осталось мало, он более склонен "докрутить".

---

### 4. energy_regen_rate

**Гипотеза:** Быстрая регенерация энергии увеличивает сессии, но снижает монетизацию энергии.

| Вариант | Скорость | Эффект |
|---------|----------|--------|
| `control` | 1 energy / 5 min | Базовое поведение |
| `fast` | 1 energy / 4 min | +20% сессий/день, -30% покупок энергии |
| `slow` | 1 energy / 6 min | -15% сессий/день, +25% покупок энергии |

**Распределение:** 33% / 33% / 34%

**Что меняется:**
- Количество сессий в день
- Вероятность покупки энергии за гемы

**Trade-off:**
- `fast`: лучше engagement, хуже монетизация
- `slow`: хуже engagement, лучше монетизация

---

### 5. ad_reward_amount

**Гипотеза:** Большая награда за рекламу увеличивает просмотры, но каннибализирует IAP.

| Вариант | Награда | Эффект |
|---------|---------|--------|
| `control` | 50 gems | Базовое поведение |
| `generous` | 100 gems | +40% просмотров рекламы, -10% IAP конверсия |
| `stingy` | 25 gems | -30% просмотров рекламы, +5% IAP конверсия |

**Распределение:** 33% / 33% / 34%

**Что меняется:**
- Награда за просмотр рекламы
- Вероятность просмотра рекламы
- Вероятность IAP покупок

**Trade-off:**
- `generous`: больше ad revenue, меньше IAP
- `stingy`: меньше ad revenue, немного больше IAP

---

### 6. late_game_offer

**Тип:** Отложенный тест (активируется на day 30+)

**Гипотеза:** Специальное предложение для "застрявших" игроков возвращает их в платящих.

| Вариант | Описание | Эффект |
|---------|----------|--------|
| `control` | Нет предложения | Базовое поведение |
| `discount_50` | -50% на gems_tier3 | +25% конверсия в IAP |
| `bonus_hero` | Бесплатный Epic герой + предложение | +15% конверсия, +10% D30-D60 retention |

**Условие активации:** `days_since_install >= 30`

**Распределение:** 33% / 33% / 34%

**Особенность:** Тест появляется в `ab_tests` события только после 30 дней с момента установки.

---

## Формат в событиях

В каждом событии поле `ab_tests` содержит варианты всех активных тестов:

```json
{
  "ab_tests": {
    "onboarding_length": "short",
    "starter_pack_price": "control",
    "gacha_pity_display": "visible",
    "energy_regen_rate": "fast",
    "ad_reward_amount": "control",
    "late_game_offer": "discount_50"  // появляется только после day 30
  }
}
```

---

## Добавление своих тестов

В `configs/default.yaml` или в override файле:

```yaml
ab_tests:
  my_new_test:
    enabled: true
    variants: ["control", "variant_a", "variant_b"]
    weights: [0.33, 0.33, 0.34]  # Сумма = 1.0
    activation_condition: null   # или "days_since_install >= N"
    effects:
      control: {}
      variant_a:
        d1_retention_mult: 1.05  # +5% D1 retention
        sessions_mult: 1.10      # +10% сессий
      variant_b:
        d1_retention_mult: 0.95
        gacha_desire_mult: 1.20  # +20% желание гачи
```

### Доступные модификаторы эффектов

| Модификатор | Описание |
|-------------|----------|
| `d1_retention_mult` | Множитель D1 retention |
| `d7_retention_mult` | Множитель D7 retention |
| `d30_d60_retention_mult` | Множитель retention D30-D60 |
| `sessions_mult` | Множитель количества сессий |
| `conversion_mult` | Множитель конверсии в покупку |
| `iap_conversion_mult` | Множитель вероятности IAP |
| `energy_purchase_mult` | Множитель покупок энергии |
| `ad_watch_mult` | Множитель просмотров рекламы |
| `gacha_desire_mult` | Множитель желания гачи |
| `gacha_desire_mult_above_50_pity` | То же, но только при pity > 50 |
| `tutorial_steps` | Количество шагов туториала |
| `price_usd` | Изменение цены продукта |
| `reward_gems` | Изменение награды |
| `regen_minutes` | Скорость регенерации энергии |

---

## Учебные задания

Студенты могут практиковаться на этих данных:

### Базовый анализ
- Посчитать размер групп, проверить равномерность распределения
- Рассчитать ключевые метрики по группам (retention, конверсия, ARPU)
- Построить доверительные интервалы

### Статистическая значимость
- Провести t-test / chi-square test
- Рассчитать p-value
- Определить минимальный размер выборки для значимости (power analysis)

### Продуктовые решения
- Оценить trade-off (например, retention vs. monetization)
- Рассчитать влияние на LTV
- Сделать рекомендацию о раскатке

### Продвинутый анализ
- Найти взаимодействия между тестами
- Сегментировать эффекты (новые vs. старые игроки, платящие vs. нет)
- Построить модель предсказания эффекта

---

## Сводная таблица эффектов

| Тест | Метрика | Control | Variant A | Variant B |
|------|---------|---------|-----------|-----------|
| `onboarding_length` | D1 Retention | base | +5% (short) | -3% (extended) |
| `onboarding_length` | D7 Retention | base | -8% (short) | +4% (extended) |
| `starter_pack_price` | Конверсия | base | -40% (higher) | +60% (lower) |
| `gacha_pity_display` | Pulls (pity>50) | base | +15% (visible) | — |
| `energy_regen_rate` | Сессии/день | base | +20% (fast) | -15% (slow) |
| `energy_regen_rate` | Покупки энергии | base | -30% (fast) | +25% (slow) |
| `ad_reward_amount` | Просмотры рекламы | base | +40% (generous) | -30% (stingy) |
| `ad_reward_amount` | IAP конверсия | base | -10% (generous) | +5% (stingy) |
| `late_game_offer` | IAP конверсия (D30+) | base | +25% (discount) | +15% (bonus) |
| `late_game_offer` | D30-D60 Retention | base | — | +10% (bonus) |
