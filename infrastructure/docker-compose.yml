version: '3.8'

services:
  # ClickHouse - колоночная БД для аналитики
  clickhouse:
    image: clickhouse/clickhouse-server:24.1
    container_name: clickhouse
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native interface
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./clickhouse/config/users.xml:/etc/clickhouse-server/users.d/users.xml
    environment:
      - CLICKHOUSE_DB=game_analytics
      - CLICKHOUSE_USER=admin
      - CLICKHOUSE_PASSWORD=admin123
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Инициализация ClickHouse (создание базы и таблиц)
  clickhouse-init:
    image: clickhouse/clickhouse-server:24.1
    container_name: clickhouse-init
    depends_on:
      clickhouse:
        condition: service_healthy
    volumes:
      - ./clickhouse/init:/init
    entrypoint: >
      sh -c "
        echo 'Waiting for ClickHouse...' &&
        sleep 5 &&
        echo 'Creating database and tables...' &&
        clickhouse-client --host clickhouse --user admin --password admin123 --multiquery < /init/01_create_tables.sql &&
        echo 'ClickHouse initialization complete!'
      "

  # Apache Superset - BI платформа
  superset:
    image: apache/superset:3.1.0
    container_name: superset
    ports:
      - "8088:8088"
    environment:
      - SUPERSET_SECRET_KEY=your-secret-key-change-in-production
      - ADMIN_USERNAME=admin
      - ADMIN_EMAIL=admin@example.com
      - ADMIN_PASSWORD=admin123
    volumes:
      - superset_home:/app/superset_home
      - ./superset/superset_config.py:/app/pythonpath/superset_config.py
    depends_on:
      clickhouse:
        condition: service_healthy
      superset-init:
        condition: service_completed_successfully
    command: >
      sh -c "superset run -h 0.0.0.0 -p 8088 --with-threads --reload"

  # Инициализация Superset (создание админа, базы)
  superset-init:
    image: apache/superset:3.1.0
    container_name: superset-init
    environment:
      - SUPERSET_SECRET_KEY=your-secret-key-change-in-production
      - ADMIN_USERNAME=admin
      - ADMIN_EMAIL=admin@example.com
      - ADMIN_PASSWORD=admin123
    volumes:
      - superset_home:/app/superset_home
      - ./superset/superset_config.py:/app/pythonpath/superset_config.py
    command: >
      sh -c "
        superset db upgrade &&
        superset fab create-admin --username admin --firstname Admin --lastname User --email admin@example.com --password admin123 || true &&
        superset init
      "
    depends_on:
      clickhouse:
        condition: service_healthy

  # Redis для кэширования Superset (опционально, но рекомендуется)
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  clickhouse_data:
  superset_home:
  redis_data:
